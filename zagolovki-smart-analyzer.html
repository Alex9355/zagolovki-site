
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –î–∑–µ–Ω–∞ ‚Äî –∞–≤—Ç–æ–∞–Ω–∞–ª–∏–∑</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body { font-family: sans-serif; background: #f9fafb; padding: 20px; }
    h1 { text-align: center; }
    .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
    input, textarea, select { width: 100%; padding: 8px; margin: 6px 0; }
    table.dataTable { margin-top: 20px; width: 100% !important; }
    .inline { display: flex; gap: 10px; }
    .inline input { flex: 1; }
    .actions span { cursor: pointer; margin-right: 10px; }
    .green { color: green; font-weight: bold; }
    .yellow { color: orange; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h1>–ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –î–∑–µ–Ω–∞</h1>

  <div>
    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input id="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫">
    <div class="inline">
      <div><label>–¢–µ–º–∞</label><input id="theme"></div>
      <div><label>–¢–∏–ø</label><input id="type"></div>
      <div><label>–≠–º–æ—Ü–∏—è</label><input id="emotion"></div>
    </div>
    <div class="inline">
      <div><label>CTR (%)</label><input id="ctr" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 12.5"></div>
      <div><label>–û—Ö–≤–∞—Ç</label><input id="reach"></div>
    </div>
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <textarea id="comment" rows="2"></textarea>
    <button onclick="addRow()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button onclick="downloadCSV()">–°–∫–∞—á–∞—Ç—å CSV</button>
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="document.getElementById('fileInput').click()">–ò–º–ø–æ—Ä—Ç CSV</button>
  </div>

  <table id="headlineTable" class="display">
    <thead>
      <tr>
        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th><th>–¢–∏–ø</th><th>–≠–º–æ—Ü–∏—è</th><th>–¢–µ–º–∞</th><th>CTR</th><th>–û—Ö–≤–∞—Ç</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
let table;
let savedRows = JSON.parse(localStorage.getItem('rows') || '[]');

document.addEventListener("DOMContentLoaded", () => {
  table = $('#headlineTable').DataTable();
  rebuildTable();
});

function analyzeTitle(title) {
  const lower = title.toLowerCase();
  let theme = '', type = '', emotion = '';

  if (lower.includes('–º—É–∂') || lower.includes('–∂–µ–Ω–∞') || lower.includes('—Å–µ–º—å—è')) theme = '–°–µ–º—å—è';
  else if (lower.includes('–¥–µ–Ω—å–≥–∏') || lower.includes('—Ä–∞–±–æ—Ç–∞')) theme = '–§–∏–Ω–∞–Ω—Å—ã';
  else if (lower.includes('–±–æ–ª—å') || lower.includes('–∑–¥–æ—Ä–æ–≤')) theme = '–ó–¥–æ—Ä–æ–≤—å–µ';
  else if (lower.includes('—Ä–µ–±—ë–Ω–æ–∫') || lower.includes('–¥–æ—á—å') || lower.includes('—Å—ã–Ω')) theme = '–î–µ—Ç–∏';
  else theme = '–û–±—â–µ–µ';

  if (lower.includes('?')) type = '–í–æ–ø—Ä–æ—Å';
  else if (lower.includes('–∫–∞–∫')) type = '–°–æ–≤–µ—Ç';
  else if (lower.includes('—Å–∫–∞–∑–∞–ª') || lower.includes('–æ—Ç–≤–µ—Ç–∏–ª–∞')) type = '–¶–∏—Ç–∞—Ç–∞';
  else type = '–û–±—ã—á–Ω—ã–π';

  if (lower.includes('–Ω–µ') || lower.includes('—É—à—ë–ª') || lower.includes('–ø–æ—Ç–µ—Ä—è–ª–∞')) emotion = '–û–±–∏–¥–∞';
  else if (lower.includes('—É–¥–∏–≤') || lower.includes('–≤–ø–µ—Ä–≤—ã–µ')) emotion = '–£–¥–∏–≤–ª–µ–Ω–∏–µ';
  else if (lower.includes('—Ä–∞–¥–æ—Å—Ç—å') || lower.includes('–≤–¥–æ—Ö–Ω–æ–≤')) emotion = '–†–∞–¥–æ—Å—Ç—å';
  else emotion = '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ';

  return { theme, type, emotion };
}

function addRow() {
  const title = document.getElementById('title').value.trim();
  const ctr = document.getElementById('ctr').value.trim();
  const reach = document.getElementById('reach').value.trim();
  const comment = document.getElementById('comment').value.trim();
  let theme = document.getElementById('theme').value.trim();
  let type = document.getElementById('type').value.trim();
  let emotion = document.getElementById('emotion').value.trim();

  if (!theme || !type || !emotion) {
    const analysis = analyzeTitle(title);
    theme = theme || analysis.theme;
    type = type || analysis.type;
    emotion = emotion || analysis.emotion;
  }

  const row = [title, type, emotion, theme, ctr, reach, comment];
  savedRows.push(row);
  localStorage.setItem('rows', JSON.stringify(savedRows));
  rebuildTable();
}

function rebuildTable() {
  table.clear();
  savedRows.forEach((row, i) => {
    const ctrNum = parseFloat(row[4]);
    let ctrClass = ctrNum >= 10 ? 'green' : (ctrNum >= 5 ? 'yellow' : 'red');
    table.row.add([
      row[0],
      row[1],
      row[2],
      row[3],
      `<span class="${ctrClass}">${row[4]}%</span>`,
      row[5],
      row[6],
      `<span onclick="editRow(${i})">‚úèÔ∏è</span><span onclick="deleteRow(${i})">üóëÔ∏è</span>`
    ]);
  });
  table.draw();
}

function editRow(i) {
  const row = savedRows[i];
  document.getElementById('title').value = row[0];
  document.getElementById('type').value = row[1];
  document.getElementById('emotion').value = row[2];
  document.getElementById('theme').value = row[3];
  document.getElementById('ctr').value = row[4];
  document.getElementById('reach').value = row[5];
  document.getElementById('comment').value = row[6];
  savedRows.splice(i, 1);
  localStorage.setItem('rows', JSON.stringify(savedRows));
  rebuildTable();
}

function deleteRow(i) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
    savedRows.splice(i, 1);
    localStorage.setItem('rows', JSON.stringify(savedRows));
    rebuildTable();
  }
}

function downloadCSV() {
  const headers = ['–ó–∞–≥–æ–ª–æ–≤–æ–∫','–¢–∏–ø','–≠–º–æ—Ü–∏—è','–¢–µ–º–∞','CTR','–û—Ö–≤–∞—Ç','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'];
  let csv = headers.join(',') + '\n';
  savedRows.forEach(r => {
    csv += r.map(x => `"${(x||'').replace(/"/g, '""')}"`).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'zagolovki.csv';
  a.click();
}

// –ò–º–ø–æ—Ä—Ç CSV
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split('\n').filter(Boolean);
    lines.shift(); // remove header
    for (let line of lines) {
      const parts = line.split(',');
      const title = parts[0]?.replace(/^"|"$/g, '').trim();
      const analysis = analyzeTitle(title);
      savedRows.push([
        title,
        parts[1]?.replace(/^"|"$/g, '').trim() || analysis.type,
        parts[2]?.replace(/^"|"$/g, '').trim() || analysis.emotion,
        parts[3]?.replace(/^"|"$/g, '').trim() || analysis.theme,
        parts[4]?.replace(/^"|"$/g, '').trim(),
        parts[5]?.replace(/^"|"$/g, '').trim(),
        parts[6]?.replace(/^"|"$/g, '').trim()
      ]);
    }
    localStorage.setItem('rows', JSON.stringify(savedRows));
    rebuildTable();
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
